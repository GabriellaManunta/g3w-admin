!function t(e,n,i){function a(o,r){if(!n[o]){if(!e[o]){var l="function"==typeof require&&require;if(!r&&l)return l(o,!0);if(s)return s(o,!0);var c=new Error("Cannot find module '"+o+"'");throw c.code="MODULE_NOT_FOUND",c}var u=n[o]={exports:{}};e[o][0].call(u.exports,function(t){var n=e[o][1][t];return a(n?n:t)},u,u.exports,t,e,n,i)}return n[o].exports}for(var s="function"==typeof require&&require,o=0;o<i.length;o++)a(i[o]);return a}({1:[function(t,e,n){function i(){this.cleanAll=function(){a.cleanAll()},this.calcola=function(t,e){a.clearIntersectLayer(),a.calcola(t).then(function(t){o.pushContent({content:new s({state:t,catastoFields:e}),backonclose:!0,closable:!1,perc:50})})}}var a=t("../pluginservice"),s=t("./vue/calcolo"),o=g3wsdk.gui.GUI;e.exports=i},{"../pluginservice":7,"./vue/calcolo":3}],2:[function(t,e,n){e.exports='<div id="cdu-calcolo">\n  <div class="text-right">\n    <button class="btn btn-primary" @click="">\n      <span class="glyphicon glyphicon-download-alt">\n      </span>\n    </button>\n  </div>\n  <div class="results nano">\n    <div class="nano-content">\n      <div v-for="particella in state">\n        <div class="cdu-calcolo-header" style="background:#3c8dbc; padding:5px;">\n          <span v-for="field in getCatastoFieldsFromResults(particella)">\n            <b> {{ field.label }} : {{ field.value }} </b>\n          </span>\n        </div>\n        <div v-if="!particella.results.length">\n          Non ci sono intesezioni\n        </div>\n        <div v-else>\n          <table class="table table-hover">\n            <thead>\n            <tr>\n              <th>\n              </th>\n              <th>\n                <input type="checkbox" checked> Accetta\n              </th>\n              <th>\n                Confronto\n              </th>\n              <th>\n                Tipo\n              </th>\n              <th>\n                Campi\n              </th>\n              <th>\n                Area | %\n              </th>\n            </tr>\n            </thead>\n            <tbody>\n            <tr v-for="intersection in particella.results">\n              <td>\n                <span @click="highLightIntersection(intersection.geometry)" class="action-button-icon glyphicon glyphicon-map-marker"></span>\n              </td>\n              <td>\n                <input type="checkbox" checked>\n              </td>\n              <td>\n                {{intersection.alias }}\n              </td>\n              <td>\n                {{intersection.geometry.type }}\n              </td>\n              <td>\n                <p v-for="field in intersection.fields">\n                  {{ field.alias }} : {{ field.value }}\n                </p>\n              </td>\n              <td>\n                {{ intersection.area }} mq | {{ intersection.perc }} %\n              </td>\n            </tr>\n            </tbody>\n          </table>\n        </div>\n      </div>\n    </div>\n  </div>\n</div>'},{}],3:[function(t,e,n){function i(t){t=t||{},s(this,t);var e=t.state||{},n=t.catastoFields;this.setInternalComponent(new l({state:e,catastoFields:n}))}var a=g3wsdk.core.utils.inherit,s=g3wsdk.core.utils.base,o=g3wsdk.gui.vue.Component,r=t("../../pluginservice"),l=Vue.extend({template:t("./calcolo.html"),data:function(){return{state:this.$options.state,catastoFields:this.$options.catastoFields}},methods:{getCatastoFieldsFromResults:function(t){var e=[];return _.forEach(this.catastoFields,function(n){e.push({label:n.label,value:t[n.field]})}),e},highLightIntersection:function(t){r.highLightIntersectFeature(t)}},created:function(){Vue.nextTick(function(){$(".nano").nanoScroller()})}});a(i,o),e.exports=i},{"../../pluginservice":7,"./calcolo.html":2}],4:[function(t,e,n){e.exports='<div id="cdu">\n  <div id="cdu-tools">\n    <button :disabled="!particelle.length" @click="calcola()" title="Calcola" type="button" class="btn btn-default ">\n      <i class="fa fa-calculator" aria-hidden="true"></i>\n      <b>CALCOLA</b>\n    </button>\n    <button @click="activeInteraction(\'modify\')" :class="{\'toggled\' : \'modify\' == buttonToggled }" title="Vertici" type="button" class="btn btn-default  pull-right cdu-tools">\n      <span  class="glyphicon glyphicon-option-horizontal" aria-hidden="true"></span>\n    </button>\n    <button @click="activeInteraction(\'rotate\')" :class="{\'toggled\' : \'rotate\' == buttonToggled }" title="Ruota Feature" type="button" class="btn btn-default  pull-right cdu-tools">\n      <span  class="glyphicon glyphicon-repeat" aria-hidden="true"></span>\n    </button>\n    <button @click="activeInteraction(\'rotateall\')" :class="{\'toggled\' : \'rotateall\' == buttonToggled }" title="Ruota tutte le features" type="button" class="btn btn-default  pull-right cdu-tools">\n      <span  class="glyphicon glyphicon-refresh" aria-hidden="true"></span>\n    </button>\n    <button @click="activeInteraction(\'move\')" :class="{\'toggled\' : \'move\' == buttonToggled }" title="Muovi Feature" type="button" class="btn btn-default  pull-right cdu-tools">\n      <span  class="glyphicon glyphicon-move" aria-hidden="true"></span>\n    </button>\n    <button @click="activeInteraction(\'moveall\')" :class="{\'toggled\' : \'moveall\' == buttonToggled }" title="Sposta tutte le features" type="button" class="btn btn-default  pull-right cdu-tools">\n      <span  class="glyphicon glyphicon-align-justify" aria-hidden="true"></span>\n    </button>\n  </div>\n  <div class="nano">\n    <div v-if="particelle.length" class="nano-content">\n        <table class="particelle table table-hover">\n          <thead>\n          <tr>\n            <th></th>\n            <th v-for="catastoField in catastoFields">{{ catastoField.label }}</th>\n            <th></th>\n          </tr>\n          </thead>\n          <tbody>\n            <tr v-for="particella in particelle">\n              <td>\n                <span @click="hightLightGeometry(particella.getGeometry())" class="action-button-icon glyphicon glyphicon-map-marker"></span>\n              </td>\n              <td v-if="isCatastoField(key)" v-for="value, key in particella.getProperties()">\n                {{ value }}\n              </td>\n              <td>\n                <i @click="deleteParticella(particella)" class="glyphicon glyphicon glyphicon-trash link trash pull-right"></i>\n              </td>\n            </tr>\n          </tbody>\n        </table>\n      </div>\n  </div>\n</div>'},{}],5:[function(t,e,n){function i(t){t=t||{},s(this,t);var e=t.particelle||[],n=t.api_url,i=t.catastoFields,a=new r;this.setService(a),s(this,t),this.setInternalComponent(new c({api_url:n,service:a,particelle:e,catastoFields:i})),this.setService(new r),this.unmount=function(){return this.internalComponent.cleanAll(),a.cleanAll(),s(this,"unmount")}}var a=g3wsdk.core.utils.inherit,s=g3wsdk.core.utils.base,o=g3wsdk.gui.vue.Component,r=t("../cduservice"),l=t("../../pluginservice"),c=Vue.extend({template:t("./cdu.html"),data:function(){return{particelle:this.$options.particelle,buttonToggled:null,catastoFields:this.$options.catastoFields}},methods:{calcola:function(){this.$options.service.calcola(this.$options.api_url,this.catastoFields)},deleteParticella:function(t){self=this,_.forEach(this.particelle,function(e,n){t==e&&self.particelle.splice(n,1)}),l.deleteParticella(t)},activeInteraction:function(t){this.buttonToggled==t?this.buttonToggled=null:this.buttonToggled=t,l.activeInteraction(t)},cleanAll:function(){var t=this;_.forEach(this.particelle,function(e,n){t.particelle.splice(n,1)})},isCatastoField:function(t){var e=!1;return _.forEach(this.catastoFields,function(n){if(t==n.field)return e=!0,!1}),e},hightLightGeometry:function(t){l.hightLightGeometry(t)}},created:function(){Vue.nextTick(function(){$(".nano").nanoScroller()})}});a(i,o),e.exports=i},{"../../pluginservice":7,"../cduservice":1,"./cdu.html":4}],6:[function(t,e,n){var i=g3wsdk.core.utils.inherit,a=g3wsdk.core.utils.base,s=g3wsdk.core.Plugin,o=g3wsdk.gui.GUI,r=t("./pluginservice"),l=t("./search/vue/seachpanel"),c=function(){a(this),this.name="cdu",this.config=null,this.init=function(){this.setPluginService(r),this.config=this.getPluginConfig(),this.registerPlugin(this.config.gid)&&(o.ready?this.setupGui():o.on("ready",_.bind(this.setupGui,this)),this.service.init(this.config))},this.setupGui=function(){var t=this,e=o.getComponent("tools"),n=e.getService();_.forEach(this.config.configs,function(e){n.addTools(1,"CDU",[{name:e.name,action:_.bind(t.showSearchPanel,this,e)}])})},this.showSearchPanel=function(t){var e=new l(t);o.showPanel(e)}};i(c,s),function(t){t.init()}(new c)},{"./pluginservice":7,"./search/vue/seachpanel":10}],7:[function(t,e,n){function i(){this._mapService=null,this._interactions={},this._layer={},this._map=null,this._activeInteraction=null,this.init=function(t){var e=this;this.config=t,this._mapService=o.getComponent("map").getService();var n=this._mapService.getProjectLayer(t.configs[0].layerCatasto).state.crs;this._map=this._mapService.getMap(),this._layer=new ol.layer.Vector({title:"CDUCatasto",source:new ol.source.Vector({projection:"EPSG:"+n,format:new ol.format.GeoJSON}),style:new ol.style.Style({stroke:new ol.style.Stroke({color:"#f00",width:1}),fill:new ol.style.Fill({color:"rgba(255,0,0,0.1)"})})}),this._intersectLayer=new ol.layer.Vector({title:"CDUOverlay",source:new ol.source.Vector({projection:"EPSG:"+n,format:new ol.format.GeoJSON}),style:new ol.style.Style({stroke:new ol.style.Stroke({color:"#1cc223",width:1}),fill:new ol.style.Fill({color:"rgba(0,255,0,0.9)"})})}),this._map.addLayer(this._layer),this._map.addLayer(this._intersectLayer),this._selectInteraction=new ol.interaction.Select({layers:[this._layer],style:new ol.style.Style({stroke:new ol.style.Stroke({color:"#f00",width:2}),fill:new ol.style.Fill({color:"rgba(255,0,0,0.5)"})})}),this._interactions={rotate:new ol.interaction.RotateFeature({features:e._selectInteraction.getFeatures(),angle:0}),move:new ol.interaction.Translate({features:e._selectInteraction.getFeatures()}),modify:new ol.interaction.Modify({features:e._selectInteraction.getFeatures()}),snap:new ol.interaction.Snap({source:this._layer.getSource()}),rotateall:new ol.interaction.RotateFeature({features:e._selectInteraction.getFeatures(),angle:0}),moveall:new ol.interaction.Translate({features:e._selectInteraction.getFeatures()})},this._map.addInteraction(this._selectInteraction),this._selectInteraction.setActive(!1),_.forEach(this._interactions,function(t){e._map.addInteraction(t),t.setActive(!1)})},this.checkIfFeaturesAreAlreadyAdded=function(t){var e=this,n=!1;return _.forEach(t,function(t){if("T"==t.attributes.tipo&&(_.forEach(e._layer.getSource().getFeatures(),function(e){if(t.attributes.gid==e.get("gid"))return n=!0,!1}),n))return!1}),n},this.deleteParticella=function(t){this._layer.getSource().removeFeature(t),this._layer.setVisible(!1),this._layer.setVisible(!0)},this.addParticella=function(t){this._layer.getSource().addFeature(t)},this.addParticelle=function(t){var e=this,n=[];return _.forEach(t,function(t){if("T"==t.attributes.tipo){var i=new ol.Feature({geometry:t.geometry});return _.forEach(t.attributes,function(t,e){i.set(e,t)}),e._layer.getSource().addFeature(i),e._activeInteraction&&e._activeInteraction.indexOf("all")>-1&&e._selectInteraction.getFeatures().push(i),e._mapService.highlightGeometry(t.geometry,{duration:1e3}),n.push(i),!1}}),n},this.cleanAll=function(){this._layer.getSource().clear(),_.forEach(this._interactions,function(t){t.setActive(!1)}),this._selectInteraction.setActive(!1)},this._getInteraction=function(t){return this._interactions[t]},this.activeInteraction=function(t){var e;if(this._activeInteraction==t)return this.disableInteractions(),void this._selectInteraction.getFeatures().clear();this._activeInteraction=t,this._selectInteraction.setActive(!1),this._selectInteraction.getFeatures().clear(),_.forEach(this._interactions,function(t){e=t,t.setActive(!1)});var n=this._getInteraction(t);switch(t){case"modify":this._interactions.snap.setActive(!0);break;case"moveall":var i=this._selectInteraction.getFeatures();_.forEach(this._layer.getSource().getFeatures(),function(t){i.push(t)});break;case"rotateall":var i=this._selectInteraction.getFeatures();_.forEach(this._layer.getSource().getFeatures(),function(t){i.push(t)})}this._selectInteraction.setActive(!0),n.setActive(!0)},this.disableInteractions=function(){_.forEach(this._interactions,function(t){t.setActive(!1)}),this._selectInteraction.setActive(!1)},this.clearIntersectLayer=function(){this._intersectLayer.getSource().clear()},this.hightLightGeometry=function(t){this._mapService.highlightGeometry(t,{duration:1e3})},this.highLightIntersectFeature=function(t){var e=new ol.format.GeoJSON,n=e.readFeature(t);this._mapService.highlightGeometry(n.getGeometry(),{duration:1e3})},this.calcola=function(t){var e=new ol.format.GeoJSON({geometryName:"geometry"}),n=e.writeFeatures(this._layer.getSource().getFeatures());return $.post(t,{features:n})}}var a=g3wsdk.core.utils.inherit,s=g3wsdk.core.G3WObject,o=g3wsdk.gui.GUI;a(i,s),e.exports=new i},{}],8:[function(t,e,n){function i(t){t=t||{},this.state={added:!1,featuresFound:!0,isValidForm:!0,particelle:[]};var e=t.api_url,n=t.catastoFields;this.addParticelle=function(t){return l.addParticelle(t)},this._featuresAlreadyAdded=function(t){return l.checkIfFeaturesAreAlreadyAdded(t)},this._showContent=function(t){this.state.particelle.push(t[0]),o.getComponent("contents").getOpen()||o.setContent({content:new c({api_url:e,catastoFields:n,particelle:this.state.particelle}),title:"Calcola CDU"})},this.getResults=function(t){var e=this;r.queryByFilter(t).then(function(t){e._parseQueryResults(t)}).fail(function(){e.state.featuresFound=!1})},this._parseQueryResults=function(t){if(t){var e=o.getComponent("queryresults").getService(),n=e._digestFeaturesForLayers(t.data),i=n.length?n[0].features:n;i.length&&!this._featuresAlreadyAdded(i)?(this.state.featuresFound=!0,this.state.added=!1,i=this.addParticelle(i),this._showContent(i)):this._featuresAlreadyAdded(i)?(this.state.featuresFound=!0,this.state.added=!0):(this.state.added=!1,this.state.featuresFound=!1)}},this.clearAll=function(){}}var a=g3wsdk.core.utils.inherit,s=g3wsdk.core.G3WObject,o=g3wsdk.gui.GUI,r=g3wsdk.core.QueryService,l=t("../pluginservice"),c=t("../cdu/vue/cdu");a(i,s),e.exports=i},{"../cdu/vue/cdu":5,"../pluginservice":7}],9:[function(t,e,n){e.exports='<div class="cdu-search-panel form-group">\n  <h4>{{title}}</h4>\n  <form id="cdu-search-form">\n    <template v-for="(forminput, index) in forminputs">\n      <div v-if="forminput.input.type == \'numberfield\'" class="form-group numeric">\n        <label :for="forminput.id + \' \'">{{ forminput.label }}</label>\n        <input type="number" v-model="formInputValues[index].value" class="form-control" :id="forminput.id">\n      </div>\n      <div v-if="forminput.input.type == \'textfield\' || forminput.input.type == \'textField\'" class="form-group text">\n        <label :for="forminput.id">{{ forminput.label }}</label>\n        <input type="text" v-model="formInputValues[index].value" class="form-control" :id="forminput.id">\n      </div>\n    </template>\n    <div class="form-group">\n      <button class="btn btn-primary btn-block pull-right" @click="addParticella($event)">Aggiungi</button>\n    </div>\n  </form>\n  <div id="cdu-search-messages" style="color:#ec971f">\n    <div v-if="state.added">\n      <b>La particella è stata già aggiunta</b>\n    </div>\n    <div v-if="!state.featuresFound">\n      <b>Nessuna particella trovata</b>\n    </div>\n    <div v-if="!state.isValidForm">\n      <b>Compila la ricerca in tutti i suoi campi</b>\n    </div>\n  </div>\n</div>\n\n'},{}],10:[function(t,e,n){function i(t){t=t||{},t.id="cdu-search-panel",t.name=t.name;var e=t.api,n=t.search,i=[];_.forEach(n.options.filter.AND,function(t){i.push({field:t.attribute,label:t.label})});var a=t.service||new r({api_url:e,catastoFields:i});s(this,t),this.setInternalPanel(new l({service:a})),this.internalPanel.state=a.state,this.init(n),this.unmount=function(){return s(this,"unmount")}}var a=g3wsdk.core.utils.inherit,s=g3wsdk.core.utils.base,o=g3wsdk.gui.vue.SearchPanel,r=t("../searchpanelservice"),l=Vue.extend({template:t("./seachpanel.html"),data:function(){return{title:"",forminputs:[],filterObject:{},formInputValues:[],state:null}},methods:{addParticella:function(t){var e=!0;t.preventDefault(),_.forEach(this.formInputValues,function(t){if(_.isNil(t.value))return e=!1,!1}),this.state.isValidForm=e,this.state.isValidForm&&(this.filterObject=this.fillFilterInputsWithValues(this.filterObject,this.formInputValues),this.$options.service.getResults([this.filterObject]))}}});a(i,o),e.exports=i},{"../searchpanelservice":8,"./seachpanel.html":9}]},{},[6]);