!function t(e,i,n){function a(o,r){if(!i[o]){if(!e[o]){var l="function"==typeof require&&require;if(!r&&l)return l(o,!0);if(s)return s(o,!0);var c=new Error("Cannot find module '"+o+"'");throw c.code="MODULE_NOT_FOUND",c}var u=i[o]={exports:{}};e[o][0].call(u.exports,function(t){var i=e[o][1][t];return a(i?i:t)},u,u.exports,t,e,i,n)}return i[o].exports}for(var s="function"==typeof require&&require,o=0;o<n.length;o++)a(n[o]);return a}({1:[function(t,e,i){function n(){this.state=a.state,this.cleanAll=function(){a.cleanAll()},this.calcola=function(t,e){a.clearIntersectLayer(),a.calcola(t.api).then(function(i){o.pushContent({content:new s({state:i,catastoFields:e,urls:t}),backonclose:!0,closable:!1,perc:50,title:"Crea Report"})})},this.deleteParticella=function(t){a.deleteParticella(t)},this.activeInteraction=function(t){a.activeInteraction(t)},this.hightLightGeometry=function(t){a.hightLightGeometry(t)}}var a=t("../pluginservice"),s=t("./vue/calcolo"),o=g3wsdk.gui.GUI;e.exports=n},{"../pluginservice":7,"./vue/calcolo":3}],2:[function(t,e,i){e.exports='<div id="cdu-calcolo">\n  <div class="text-right">\n    <button class="btn btn-primary" @click="createDoc()">\n      <span class="glyphicon glyphicon-download-alt"></span>\n      <b style="font-family: \'Source Sans Pro\', \'Helvetica Neue\', Helvetica, Arial, sans-serif;"> Scarica ODT</b>\n    </button>\n  </div>\n  <div class="results nano">\n    <div class="nano-content">\n      <div v-for="particella, idParticella in state">\n        <div class="cdu-calcolo-header" style="background:#3c8dbc; padding:5px;">\n          <span v-for="field in getCatastoFieldsFromResults(particella)">\n            <b> {{ field.label }} : {{ field.value }} </b>\n          </span>\n        </div>\n        <div v-if="!particella.results.length">\n          Non ci sono intesezioni\n        </div>\n        <div v-else>\n          <table class="table table-hover">\n            <thead>\n            <tr>\n              <th>\n              </th>\n              <th>\n                <input :id="idParticella" type="checkbox" v-model="parentCheckBoxes[idParticella].checked" class="checkbox pull-right">\n                <label :for="idParticella">Accetta</label>\n              </th>\n              <th>\n                Confronto\n              </th>\n              <th>\n                Tipo\n              </th>\n              <th>\n                Campi\n              </th>\n              <th>\n                Area | %\n              </th>\n            </tr>\n            </thead>\n            <tbody>\n            <tr v-for="intersection in particella.results">\n              <td>\n                <span @click="highLightIntersection(intersection.geometry)" class="action-button-icon glyphicon glyphicon-map-marker"></span>\n              </td>\n              <td>\n                <input :id="\'intersection_\'+intersection.id" class="checkbox intersection" v-model="parentCheckBoxes[idParticella].childs[intersection.id]" type="checkbox">\n                <label :for="\'intersection_\'+intersection.id"></label>\n              </td>\n              <td>\n                {{intersection.alias }}\n              </td>\n              <td>\n                {{intersection.geometry.type }}\n              </td>\n              <td>\n                <p v-for="field in intersection.fields">\n                  {{ field.alias }} : {{ field.value }}\n                </p>\n              </td>\n              <td>\n                {{ intersection.area }} mq | {{ intersection.perc }} %\n              </td>\n            </tr>\n            </tbody>\n          </table>\n        </div>\n      </div>\n    </div>\n  </div>\n</div>'},{}],3:[function(t,e,i){function n(t){t=t||{},s(this,t);var e=t.state||{},i=t.catastoFields,n=t.urls,a={};_.forEach(e,function(t,e){a[e]={checked:!0,childs:{}},_.forEach(t.results,function(t){a[e].childs[t.id]=!0}),l["parentCheckBoxes."+e+".checked"]=function(t){return function(e,i){_.forEach(a[t].childs,function(i,n){a[t].childs[n]=e})}}(e)}),this.setInternalComponent(new c({state:e,catastoFields:i,urls:n,parentCheckBoxes:a}))}var a=g3wsdk.core.utils.inherit,s=g3wsdk.core.utils.base,o=g3wsdk.gui.vue.Component,r=t("../../pluginservice"),l={},c=Vue.extend({template:t("./calcolo.html"),data:function(){return{state:this.$options.state,catastoFields:this.$options.catastoFields,docurl:this.$options.urls.docurl,parentCheckBoxes:this.$options.parentCheckBoxes}},methods:{getCatastoFieldsFromResults:function(t){var e=[];return _.forEach(this.catastoFields,function(i){e.push({label:i.label,value:t[i.field]})}),e},highLightIntersection:function(t){r.highLightIntersectFeature(t)},getIdsChecked:function(){var t=[];return _.forEach(this.parentCheckBoxes,function(e){_.forEach(e.childs,function(e,i){e&&t.push(1*i)})}),t},hasChildCheck:function(t){var e=!1;return _.forEach(this.parentCheckBoxes[t].childs,function(t,i){t&&(e=!0)}),e},createDoc:function(){var t=this.getIdsChecked();$.fileDownload(this.docurl,{successCallback:function(t){},failCallback:function(t,e){},httpMethod:"POST",data:{id:t.join()}})}},watch:l,created:function(){Vue.nextTick(function(){$(".nano").nanoScroller()})}});a(n,o),e.exports=n},{"../../pluginservice":7,"./calcolo.html":2}],4:[function(t,e,i){e.exports='<div id="cdu">\n  <div id="cdu-tools">\n    <div class="group-tools btn-group">\n      <!--controlli feature singola-->\n      <button @click="activeInteraction(\'modify\')" :class="{\'toggled\' : \'modify\' == state.buttonToggled }" title="Vertici" type="button" class="btn btn-default  cdu-tools" >\n        <img :src="resourcesurl+\'images/cduMoveVertexFeature.png\'">\n      </button>\n      <button @click="activeInteraction(\'rotate\')" :class="{\'toggled\' : \'rotate\' == state.buttonToggled }" title="Ruota Feature" type="button" class="btn btn-default  cdu-tools">\n        <img :src="resourcesurl+\'images/cduRotateFeature.png\'">\n      </button>\n      <button @click="activeInteraction(\'move\')" :class="{\'toggled\' : \'move\' == state.buttonToggled }" title="Muovi Feature" type="button" class="btn btn-default cdu-tools" style="margin-right: 20px;">\n        <img :src="resourcesurl+\'images/cduMoveFeature.png\'">\n      </button>\n      <!--fine controlli feature singola-->\n      <!--controlli multi features-->\n      <button @click="activeInteraction(\'rotateall\')" :class="{\'toggled\' : \'rotateall\' == state.buttonToggled }" title="Ruota tutte le features" type="button" class="btn btn-default cdu-tools">\n       <img :src="resourcesurl+\'images/cduRotateFeatures.png\'">\n      </button>\n      <button @click="activeInteraction(\'moveall\')" :class="{\'toggled\' : \'moveall\' == state.buttonToggled }" title="Sposta tutte le features" type="button" class="btn btn-default  cdu-tools">\n        <img :src="resourcesurl+\'images/cduMoveFeatures.png\'">\n      </button>\n      <!--fine controlli multi features-->\n    </div>\n    <div class="group-calcola btn-group">\n      <button :disabled="!particelle.length" @click="calcola()" title="Calcola" type="button" class="calcola btn btn-default ">\n        <i class="fa fa-calculator" aria-hidden="true"></i>\n        <b>CALCOLA</b>\n      </button>\n    </div>\n  </div>\n  <div class="nano">\n    <div v-if="particelle.length" class="nano-content">\n        <table class="particelle table table-hover">\n          <thead>\n          <tr>\n            <th></th>\n            <th v-for="catastoField in catastoFields">{{ catastoField.label }}</th>\n            <th></th>\n          </tr>\n          </thead>\n          <tbody>\n            <tr v-for="particella in particelle">\n              <td>\n                <span @click="hightLightGeometry(particella.getGeometry())" class="action-button-icon glyphicon glyphicon-map-marker"></span>\n              </td>\n              <td v-if="isCatastoField(key)" v-for="value, key in particella.getProperties()">\n                {{ value }}\n              </td>\n              <td>\n                <i @click="deleteParticella(particella)" class="glyphicon glyphicon glyphicon-trash link trash pull-right"></i>\n              </td>\n            </tr>\n          </tbody>\n        </table>\n      </div>\n  </div>\n</div>'},{}],5:[function(t,e,i){function n(t){t=t||{},t.id="cdu",s(this,t);var e=t.particelle||[],i=t.urls,n=t.catastoFields,a=new l;this.setService(a),s(this,t),this.setInternalComponent(new c({urls:i,service:a,particelle:e,catastoFields:n})),this.setService(new l),this.unmount=function(){return this.internalComponent.cleanAll(),a.cleanAll(),s(this,"unmount")}}var a=g3wsdk.core.utils.inherit,s=g3wsdk.core.utils.base,o=g3wsdk.gui.vue.Component,r=g3wsdk.gui.GUI,l=t("../cduservice"),c=Vue.extend({template:t("./cdu.html"),data:function(){return{state:this.$options.service.state,particelle:this.$options.particelle,catastoFields:this.$options.catastoFields,resourcesurl:r.getResourcesUrl()}},methods:{calcola:function(){this.$options.service.calcola(this.$options.urls,this.catastoFields)},deleteParticella:function(t){self=this,_.forEach(this.particelle,function(e,i){t==e&&self.particelle.splice(i,1)}),this.$options.service.deleteParticella(t)},activeInteraction:function(t){this.$options.service.activeInteraction(t)},cleanAll:function(){var t=this;_.forEach(this.particelle,function(e,i){t.particelle.splice(i,1)})},isCatastoField:function(t){var e=!1;return _.forEach(this.catastoFields,function(i){if(t==i.field)return e=!0,!1}),e},hightLightGeometry:function(t){this.$options.service.hightLightGeometry(t)}},created:function(){Vue.nextTick(function(){$(".nano").nanoScroller()})}});a(n,o),e.exports=n},{"../cduservice":1,"./cdu.html":4}],6:[function(t,e,i){var n=g3wsdk.core.utils.inherit,a=g3wsdk.core.utils.base,s=g3wsdk.core.Plugin,o=g3wsdk.gui.GUI,r=t("./pluginservice"),l=t("./search/vue/seachpanel"),c=function(){a(this),this.name="cdu",this.init=function(){this.setService(r),this.config=this.getConfig(),this.registerPlugin(this.config.gid)&&(o.ready?this.setupGui():o.on("ready",_.bind(this.setupGui,this)),this.service.init(this.config))},this.setupGui=function(){var t=this,e=o.getComponent("tools"),i=e.getService();_.forEach(this.config.configs,function(e){i.addTools(1,"CDU",[{name:e.name,action:_.bind(t.showSearchPanel,this,e)}])})},this.showSearchPanel=function(t){var e=new l(t);o.showPanel(e)}};n(c,s),function(t){t.init()}(new c)},{"./pluginservice":7,"./search/vue/seachpanel":10}],7:[function(t,e,i){function n(){s(this),this._mapService=null,this._interactions={},this._layer={},this._map=null,this._activeInteraction=null,this.state={buttonToggled:null},this.init=function(t){var e=this;this.config=t,this._mapService=o.getComponent("map").getService(),this._mapService.onafter("controlClick",function(){e.disableInteractions()});var i=this._mapService.getProjectLayer(t.configs[0].layerCatasto).state.crs;this._map=this._mapService.getMap(),this._layer=new ol.layer.Vector({title:"CDUCatasto",source:new ol.source.Vector({projection:"EPSG:"+i,format:new ol.format.GeoJSON}),style:new ol.style.Style({stroke:new ol.style.Stroke({color:"#f00",width:1}),fill:new ol.style.Fill({color:"rgba(255,0,0,0.1)"})})}),this._intersectLayer=new ol.layer.Vector({title:"CDUOverlay",source:new ol.source.Vector({projection:"EPSG:"+i,format:new ol.format.GeoJSON}),style:new ol.style.Style({stroke:new ol.style.Stroke({color:"#1cc223",width:1}),fill:new ol.style.Fill({color:"rgba(0,255,0,0.9)"})})}),this._map.addLayer(this._layer),this._map.addLayer(this._intersectLayer),this._selectInteraction=new ol.interaction.Select({layers:[this._layer],style:new ol.style.Style({stroke:new ol.style.Stroke({color:"#f00",width:2}),fill:new ol.style.Fill({color:"rgba(255,0,0,0.5)"})})}),this._interactions={rotate:new ol.interaction.RotateFeature({features:e._selectInteraction.getFeatures(),angle:0}),move:new ol.interaction.Translate({features:e._selectInteraction.getFeatures()}),modify:new ol.interaction.Modify({features:e._selectInteraction.getFeatures()}),snap:new ol.interaction.Snap({source:this._layer.getSource()}),rotateall:new ol.interaction.RotateFeature({features:e._selectInteraction.getFeatures(),angle:0}),moveall:new ol.interaction.Translate({features:e._selectInteraction.getFeatures()})},this._map.addInteraction(this._selectInteraction),this._selectInteraction.setActive(!1),_.forEach(this._interactions,function(t){e._map.addInteraction(t),t.setActive(!1)})},this.checkIfFeaturesAreAlreadyAdded=function(t,e){var i=this,n=!1;return _.forEach(t,function(t){if(_.forEach(i._layer.getSource().getFeatures(),function(i){if(t.attributes[e[0].field]==i.get(e[0].field)&&t.attributes[e[1].field]==i.get(e[1].field))return n=!0,!1}),n)return!1}),n},this.deleteParticella=function(t){self=this,this._layer.getSource().removeFeature(t),this._layer.setVisible(!1),this._layer.setVisible(!0),this._layer.getSource().getFeatures().length||o.closeContent()},this.addParticella=function(t){this._layer.getSource().addFeature(t)},this.addParticelle=function(t){var e=this,i=[];return _.forEach(t,function(n){if(1==t.length||t.length>1&&"T"==n.attributes.tipo){var a=new ol.Feature({geometry:n.geometry});return _.forEach(n.attributes,function(t,e){a.set(e,t)}),e._layer.getSource().addFeature(a),e._activeInteraction&&e._activeInteraction.indexOf("all")>-1&&e._selectInteraction.getFeatures().push(a),e._mapService.highlightGeometry(n.geometry,{duration:1e3}),i.push(a),!1}}),i},this.cleanAll=function(){this._layer.getSource().clear(),this.disableInteractions(),this.state.buttonToggled=null},this.disableInteractions=function(){_.forEach(this._interactions,function(t){t.setActive(!1)}),this._selectInteraction.getFeatures().clear(),this._selectInteraction.setActive(!1),this._activeInteraction=null,this.state.buttonToggled=null},this._getInteraction=function(t){return this._interactions[t]},this._selectAllFeatures=function(){var t=this._selectInteraction.getFeatures();_.forEach(this._layer.getSource().getFeatures(),function(e){t.push(e)})},this.activeInteraction=function(t){this.state.buttonToggled==t?this.state.buttonToggled=null:this.state.buttonToggled=t;var e,i;if(this._activeInteraction==t)return void this.disableInteractions();switch(["move","modify","rotate"].indexOf(this._activeInteraction)>-1&&["move","modify","rotate"].indexOf(t)>-1||this._selectInteraction.getFeatures().clear(),this._activeInteraction=t,this._selectInteraction.setActive(!1),_.forEach(this._interactions,function(t){e=t,t.setActive(!1)}),t){case"modify":this._interactions.snap.setActive(!0);break;case"moveall":case"rotateall":this._selectAllFeatures()}this._selectInteraction.setActive(!0),i=this._getInteraction(t),i.setActive(!0),this._mapService._unToggleControls()},this.clearIntersectLayer=function(){this._intersectLayer.getSource().clear()},this.hightLightGeometry=function(t){this._mapService.highlightGeometry(t,{duration:1e3})},this.highLightIntersectFeature=function(t){var e=new ol.format.GeoJSON,i=e.readFeature(t);this._mapService.highlightGeometry(i.getGeometry(),{duration:1e3})},this.calcola=function(t){var e=new ol.format.GeoJSON({geometryName:"geometry"}),i=e.writeFeatures(this._layer.getSource().getFeatures());return $.post(t,{features:i})}}var a=g3wsdk.core.utils.inherit,s=g3wsdk.core.utils.base,o=(g3wsdk.core.G3WObject,g3wsdk.gui.GUI),r=g3wsdk.core.PluginService;a(n,r),e.exports=new n},{}],8:[function(t,e,i){function n(t){t=t||{},this.state={added:!1,featuresFound:!0,isValidForm:!0,particelle:[]};var e=t.urls,i=t.catastoFields;this.addParticelle=function(t){return l.addParticelle(t)},this._featuresAlreadyAdded=function(t){return l.checkIfFeaturesAreAlreadyAdded(t,i)},this._showContent=function(t){if(t.length){this.state.particelle.push(t[0]);var n=o.getComponent("contents");n.getOpen()&&n.getComponentById("cdu")||o.setContent({content:new c({urls:e,catastoFields:i,particelle:this.state.particelle}),title:"Calcola CDU"})}},this.getResults=function(t){var e=this;r.queryByFilter(t).then(function(t){e._parseQueryResults(t)}).fail(function(){e.state.featuresFound=!1})},this._parseQueryResults=function(t){if(t){var e=o.getComponent("queryresults").getService(),i=e._digestFeaturesForLayers(t.data),n=i.length?i[0].features:i;n.length&&!this._featuresAlreadyAdded(n)?(this.state.featuresFound=!0,this.state.added=!1,n=this.addParticelle(n),this._showContent(n)):this._featuresAlreadyAdded(n)?(this.state.featuresFound=!0,this.state.added=!0):(this.state.added=!1,this.state.featuresFound=!1)}},this.closeContent=function(){o.closeContent()}}var a=g3wsdk.core.utils.inherit,s=g3wsdk.core.G3WObject,o=g3wsdk.gui.GUI,r=g3wsdk.core.QueryService,l=t("../pluginservice"),c=t("../cdu/vue/cdu");a(n,s),e.exports=n},{"../cdu/vue/cdu":5,"../pluginservice":7}],9:[function(t,e,i){e.exports='<div class="cdu-search-panel form-group">\n  <h4>{{title}}</h4>\n  <form id="cdu-search-form">\n    <template v-for="(forminput, index) in forminputs">\n      <div v-if="forminput.input.type == \'numberfield\'" class="form-group numeric">\n        <label :for="forminput.id + \' \'">{{ forminput.label }}</label>\n        <input type="number" v-model="formInputValues[index].value" class="form-control" :id="forminput.id">\n      </div>\n      <div v-if="forminput.input.type == \'textfield\' || forminput.input.type == \'textField\'" class="form-group text">\n        <label :for="forminput.id">{{ forminput.label }}</label>\n        <input type="text" v-model="formInputValues[index].value" class="form-control" :id="forminput.id">\n      </div>\n    </template>\n    <div class="form-group">\n      <button class="btn btn-primary btn-block pull-right" @click="addParticella($event)">Aggiungi</button>\n    </div>\n  </form>\n  <div id="cdu-search-messages" style="color:#ec971f">\n    <div v-if="state.added">\n      <b>La particella è stata già aggiunta</b>\n    </div>\n    <div v-if="!state.featuresFound">\n      <b>Nessuna particella trovata</b>\n    </div>\n    <div v-if="!state.isValidForm">\n      <b>Compila la ricerca in tutti i suoi campi</b>\n    </div>\n  </div>\n</div>\n\n'},{}],10:[function(t,e,i){function n(t){t=t||{},t.id="cdu-search-panel",t.name=t.name;var e=t.api,i=t.docurl,n=t.search,a=[];_.forEach(n.options.filter.AND,function(t){a.push({field:t.attribute,label:t.label})});var o=t.service||new r({urls:{api:e,docurl:i},catastoFields:a});s(this,t),this.setInternalPanel(new l({service:o})),this.internalPanel.state=o.state,this.init(n),this.unmount=function(){return o.closeContent(),s(this,"unmount")}}var a=g3wsdk.core.utils.inherit,s=g3wsdk.core.utils.base,o=g3wsdk.gui.vue.SearchPanel,r=t("../searchpanelservice"),l=Vue.extend({template:t("./seachpanel.html"),data:function(){return{title:"",forminputs:[],filterObject:{},formInputValues:[],state:null}},methods:{addParticella:function(t){var e=!0;t.preventDefault(),_.forEach(this.formInputValues,function(t){if(_.isNil(t.value))return e=!1,!1}),this.state.isValidForm=e,this.state.isValidForm&&(this.filterObject=this.fillFilterInputsWithValues(this.filterObject,this.formInputValues),this.$options.service.getResults([this.filterObject]))}}});a(n,o),e.exports=n},{"../searchpanelservice":8,"./seachpanel.html":9}]},{},[6]);