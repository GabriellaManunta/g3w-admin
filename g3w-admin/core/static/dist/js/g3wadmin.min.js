window.g3wadmin={},_.extend(g3wadmin,{tpl:{},widget:{},ui:{},forms:{},utils:{},currentModal:null,currentForm:null,bootstrap:function(){var t=this;this.ui.initCrudDetailWidget(),this.ui.initCrudDeleteWidget();var e=$('[data-widget-type="htmlItem"]');$.each(e,function(){t.widget.loadHtmlItem($(this))}),$('[data-widget-type="addProjectGroup"]').click(function(e){t.widget.addProjectGroup($(this))}),t.widget.ajaxUpload($('[data-widget-type="ajaxUpload"]')),$(".wys5").wysihtml5(),this.ui.initRadioCheckbox(),this.ui.initBootstrapDatepicker(),this.ui.initSelect2(),this.ui.initBackHistory(),this.ui.initAjaxFormWidget(),this.ui.initAjaxFilerWidget(),this.ui.initAjaxDownload(),this.ui.initPushMenu(),this.ui.showMessageOnLoad(),this.ui.initSetProjectPanoramicWidget(),this.ui.initMapSetExtent()}}),window.ga=g3wadmin,_.extend(g3wadmin.tpl,{tplDefValues:{dialog:{modalTitle:"Titolo",modalBody:"Contenuto",modalClass:"",modalSize:"",closeButton:!0,closeButtonText:"Close",confirmButton:!0,confirmButtonText:"Ok"},ajaxError:{textStatus:"500",errorMessage:"",moreInfo:null}},dialog:_.template('    <div class="modal fade" tabindex="-1" role="dialog">        <div class="modal-dialog <%= modalClass %> <%= modalSize %>">        <div class="modal-content">          <div class="modal-header">            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>            <h4 class="modal-title"><%= modalTitle %></h4>          </div>          <div class="modal-body">            <%= modalBody %>          </div>          <div class="modal-footer">            <% if(closeButton) { %>            <button type="button" class="modal-button-close btn btn-default" data-dismiss="modal"><i class="fa fa-close"></i> <%= closeButtonText %></button>            <% } %>            <% if(confirmButton) { %>            <button type="button" class="modal-button-confirm btn btn-success"><i class="fa fa-check"></i> <%= confirmButtonText %></button>            <% } %>          </div>        </div>      </div>    </div>'),ajaxError:_.template("    <h3><%= textStatus %></h3>    <p><%= errorMessage %></p>    <% if(moreInfo) { %>        <p><%= moreInfo %></p>    <% } %>"),ajaxFormFieldError:_.template('    <span id="<%= errorId %>" class="help-block"><strong><%= errorMessage %></strong></span>    '),ajaxFiler:_.template('    <form action="<%= actionUrl %>" method="post" enctype="multipart/form-data">        <input type="file" name="files[]" id="filer_input" multiple="multiple">    </form>    '),ajaxFiler_changeInput:_.template('    <div class="jFiler-input-dragDrop"><div class="jFiler-input-inner"><div class="jFiler-input-icon"><i class="icon-jfi-cloud-up-o"></i></div><div class="jFiler-input-text"><h3>Drag&Drop files here</h3> <span style="display:inline-block; margin: 15px 0">or</span></div><a class="jFiler-input-choose-btn blue">Browse Files</a></div></div>    '),ajaxFiler_box:_.template('    <ul class="jFiler-items-list jFiler-items-grid"></ul>    '),ajaxFiler_item:_.template('    <li class="jFiler-item">        <div class="jFiler-item-container">            <div class="jFiler-item-inner">                <div class="jFiler-item-thumb">                    <div class="jFiler-item-status"></div>                    <div class="jFiler-item-info">                        <span class="jFiler-item-title"><b title="{{fi-name}}">{{fi-name | limitTo: 25}}</b></span>                        <span class="jFiler-item-others">{{fi-size2}}</span>                    </div>                    {{fi-image}}                </div>                <div class="jFiler-item-assets jFiler-row">                    <ul class="list-inline pull-left">                        <li>{{fi-progressBar}}</li>                    </ul>                    <ul class="list-inline pull-right">                        <li><a class="icon-jfi-trash jFiler-item-trash-action"></a></li>                    </ul>                </div>            </div>        </div>    </li>    '),ajaxFiler_itemAppend:_.template('    <li class="jFiler-item">        <div class="jFiler-item-container">            <div class="jFiler-item-inner">                <div class="jFiler-item-thumb">                    <div class="jFiler-item-status"></div>                    <div class="jFiler-item-info">                        <span class="jFiler-item-title"><b title="{{fi-name}}">{{fi-name | limitTo: 25}}</b></span>                        <span class="jFiler-item-others">{{fi-size2}}</span>                    </div>                    {{fi-image}}                </div>                <div class="jFiler-item-assets jFiler-row">                    <ul class="list-inline pull-left">                        <li><span class="jFiler-item-others">{{fi-icon}}</span></li>                    </ul>                    <ul class="list-inline pull-right">                        <li><a class="icon-jfi-trash jFiler-item-trash-action"></a></li>                    </ul>                </div>            </div>        </div>    </li>    '),ajaxFiler_progresBar:_.template('    <div class="bar"></div>    '),ajaxFiler_successMsg:_.template('    <div class="jFiler-item-others text-success"><i class="icon-jfi-check-circle"></i> Success</div>    '),ajaxFiler_errorMsg:_.template('    <div class="jFiler-item-others text-error"><i class="icon-jfi-minus-circle"></i> Error</div>    '),mapContainer:_.template('    <div id="modalMap" class="modalMap"></div>    ')}),_.extend(g3wadmin.ui,{modal:function(t){this.$modal=t,this.data=new Object,this.$modal.on("hidden.bs.modal",function(t){$(this).remove()}),this.show=function(){this.$modal.modal("show")},this.hide=function(){this.$modal.modal("hide")},this.setBody=function(t){this.$modal.find(".modal-body").html(t)},this.setTitle=function(t){this.$modal.find(".modal-title").html(t)},this.setConfirmButtonAction=function(t){this.$modal.find(".modal-button-confirm").click(t)}},_buildModal:function(t){var e=$(ga.tpl.dialog(_.extendOwn(_.clone(ga.tpl.tplDefValues.dialog),t)));return new this.modal(e)},buildDefaultModal:function(t){return _.isObject(t)||(t={}),t.modalClass="",this._buildModal(t)},buildDangerModal:function(t){return _.isObject(t)||(t={}),t.modalClass="modal-danger",this._buildModal(t)},buildWarningModal:function(t){return _.isObject(t)||(t={}),t.modalClass="modal-warning",this._buildModal(t)},mapModal:function(t){_.isObject(t)||(t={}),_.extend(t,{modalBody:ga.tpl.mapContainer()});var e=this._buildModal(t);t.extent;return e.map={},e.$modal.on("shown.bs.modal",function(a){if(e.map=L.map($(this).find("#modalMap")[0],{center:[0,0],zoom:1}),L.tileLayer("http://{s}.tile.osm.org/{z}/{x}/{y}.png?{foo}",{foo:"bar"}).addTo(e.map),e.drawnItems=new L.FeatureGroup,_.has(t,"bboxLayer")&&!_.isNull(t.bboxLayer)){var i=t.bboxLayer.split(","),r=[[i[1],i[0]],[i[3],i[2]]];e.drawnLayer=L.rectangle(r),e.drawnLayer.editing.enable(),e.drawnItems.addLayer(e.drawnLayer),e.map.fitBounds(r)}else e.drawnLayer={};e.map.addLayer(e.drawnItems);var o=new L.Control.Draw({draw:{polyline:!1,polygon:!1,circle:!1,marker:!1},edit:{featureGroup:e.drawnItems,edit:!1,remove:!1}});e.map.addControl(o),e.map.on("draw:drawstart",function(t){e.drawnItems.clearLayers()}),e.map.on("draw:created",function(t){t.layerType;e.drawnLayer=t.layer,e.drawnLayer.editing.enable(),e.drawnItems.addLayer(e.drawnLayer)})}),e},initCrudDeleteWidget:function(){$(document).on("click",'[data-widget-type="deleteItem"]',function(t){ga.widget.deleteItem($(this))})},initCrudDetailWidget:function(){$(document).on("click",'[data-widget-type="detailItem"]',function(t){ga.widget.showDetailItem($(this))})},initSetProjectPanoramicWidget:function(){$(document).on("ifChecked",'[data-widget-type="setProjectPanoramic"]',function(t){ga.widget.setProjectPanoramic($(this))})},initLinkWidget2Layer:function(){$(document).on("ifChecked",'[data-widget-type="linkWidget2Layer"]',function(t){ga.widget.linkWidget2Layer($(this))}).on("ifUnchecked",'[data-widget-type="linkWidget2Layer"]',function(t){ga.widget.linkWidget2Layer($(this),!1)})},initSetLayerCached:function(){$(document).on("ifChecked",'[data-widget-type="setLayerCached"]',function(t){ga.widget.setLayerCached($(this))}).on("ifUnchecked",'[data-widget-type="setLayerCached"]',function(t){ga.widget.setLayerCached($(this),!1)})},initRadioCheckbox:function(t){if(_.isUndefined(t))var e=$('input[type="checkbox"], input[type="radio"]');else var e=$(t).find('input[type="checkbox"], input[type="radio"]');e.iCheck({checkboxClass:"icheckbox_flat-green",radioClass:"iradio_flat-green"})},initBootstrapDatepicker:function(t){if(_.isUndefined(t))var e=$(".datepicker");else var e=$(t).find(".datepicker");e.datepicker({language:CURRENT_LANGUAGE_CODE})},initSelect2:function(t){if(_.isUndefined(t))var e=$(".select2");else var e=$(t).find(".select2");e.select2()},initBackHistory:function(){$('[data-widget-type="backHistory"]').click(function(){return parent.history.back(),!1})},initAjaxFormWidget:function(){$(document).on("click",'[data-widget-type="ajaxForm"]',function(t){ga.widget.ajaxForm($(this))})},initAjaxFilerWidget:function(){$(document).on("click",'[data-widget-type="ajaxFiler"]',function(t){ga.widget.ajaxFiler($(this))})},initAjaxDownload:function(){$(document).on("click",'[data-widget-type="ajaxDownload"]',function(t){ga.widget.ajaxDownload($(this))})},initMapSetExtent:function(){$(document).on("click",'[data-widget-type="mapSetExtent"]',function(t){ga.widget.mapSetExtent($(this))})},showMessageOnLoad:function(t){if(_.isUndefined(t))var e=$('[data-widget-type="showMessageOnLoad"]');else var e=$(t).find('[data-widget-type="showMessageOnLoad"]');e.length>0&&ga.widget.showMessageOnLoad(e)},initPushMenu:function(){var t=$("body"),e={path:"/"};t.on("collapsed.pushMenu",function(t){$.cookie("g3wadmin_sidebar_status","collapsed",e)}).on("expanded.pushMenu",function(t){$.cookie("g3wadmin_sidebar_status","expanded",e)})},initDataTable:function(t,e){if(_.isObject(t)&&(e=t,t=void 0),_.isUndefined(t))var a=$('[data-widget-type="dataTable"]');else var a=$(t).find('[data-widget-type="dataTable"]');var i=a.DataTable(e);a.find('[data-widget-type="detailItemDataTable"]').click(function(t){ga.widget.showDetailItemDataTable(i,$(this))})}}),_.extend(g3wadmin.widget,{_deleteItemParams:["delete-url","item-selector","modal-title"],_detailItemParams:["detail-url","modal-title"],_detailItemDataTableParams:["detail-url"],_loadHtmlItemParams:["html-url","target-selector"],_ajaxFormParams:["form-url","modal-title","modal-size"],_ajaxFilerParams:["action-url","modal-title","file-extensions"],_setProjectPanoramic:["ajax-url"],_linkWidget2Layer:["ajax-url"],_setLayerCached:["ajax-url"],_setAjaxDownload:["ajax-url"],_mapSetExtent:["crs"],deleteItem:function(t){try{var e=ga.utils.getDataAttrs(t,this._deleteItemParams);if(_.isUndefined(e["delete-url"]))throw new Error("Attribute data-delete-url not defined");var a=t.parent().find(".pre-delete-message").html(),i=ga.ui.buildDefaultModal({modalTitle:"Delete item",modalBody:"Are you sure to delete this Item?"+a,closeButtonText:"No"}),r=function(){var t={};ga.utils.addCsfrtokenData(t),$.ajax({method:"post",url:e["delete-url"],data:t,success:function(t){var a=$(e["item-selector"]);a.toggle(300,function(){$(this).remove()}),i.hide()},error:function(t,e,a){ga.widget.showError(ga.utils.buildAjaxErrorMessage(t.status,a))}})};i.setConfirmButtonAction(r),i.show()}catch(o){this.showError(o.message)}},showDetailItem:function(t){try{var e=ga.utils.getDataAttrs(t,this._detailItemParams);if(_.isUndefined(e["detail-url"]))throw new Error("Attribute data-detail-url not defined");$.ajax({method:"get",url:e["detail-url"],success:function(t){var a=ga.ui.buildDefaultModal({modalTitle:_.isUndefined(e["modal-title"])?gettext("Detail object"):e["modal-title"],modalBody:t,closeButtonText:gettext("Close"),confirmButton:!1});a.show()},error:function(t,e,a){ga.widget.showError(ga.utils.buildAjaxErrorMessage(t.status,a))}})}catch(a){this.showError(a.message)}},showDetailItemDataTable:function(t,e,a){try{var i=ga.utils.getDataAttrs(e,this._detailItemParams);if(_.isUndefined(i["detail-url"]))throw new Error("Attribute data-detail-url not defined");a=!_.isUndefined(a);var r=e.closest("tr"),o=t.row(r),n=($.inArray(r.attr("id"),[]),function(){$.ajax({method:"get",url:i["detail-url"],success:function(t){o.child(t).show()},complete:function(){var t=arguments[1];"success"==t&&ga.ui.initRadioCheckbox(o.child())},error:function(t,e,a){ga.widget.showError(ga.utils.buildAjaxErrorMessage(t.status,a))}})});a?n():o.child.isShown()?(r.removeClass("details"),o.child.hide()):(r.addClass("details"),n())}catch(s){this.showError(s.message)}},loadHtmlItem:function(t){try{var e=ga.utils.getDataAttrs(t,this._loadHtmlItemParams);if(_.isUndefined(e["html-url"]))throw new Error("Attribute data-html-url not defined");$.ajax({method:"get",url:e["html-url"],success:function(t){$(e["target-selector"]).html(t)},complete:function(){var t=arguments[1];"success"==t&&ga.ui.initRadioCheckbox(e["target-selector"])},error:function(t,e,a){ga.widget.showError(ga.utils.buildAjaxErrorMessage(t.status,a))}})}catch(a){this.showError(a.message)}},ajaxForm:function(t){try{var e=ga.utils.getDataAttrs(t,this._ajaxFormParams);if(_.isUndefined(e["form-url"]))throw new Error("Attribute data-form-url not defined");$.ajax({method:"get",url:e["form-url"],success:function(a){var i=ga.currentModal=ga.ui.buildDefaultModal({modalTitle:_.isUndefined(e["modal-title"])?"Form title":e["modal-title"],modalBody:a,modalSize:_.isUndefined(e["modal-size"])?"":e["modal-size"]});i.data.$evoker=t,i.show();var r=ga.currentForm=new ga.forms.form(i.$modal.find("form"));r.setAction(e["form-url"]),r.setOnSuccesAction(function(){i.hide(),window.location.reload()}),i.setConfirmButtonAction(r.sendData),ga.ui.initRadioCheckbox(i.$modal),ga.ui.initBootstrapDatepicker(i.$modal),ga.ui.initSelect2(i.$modal)},error:function(t,e,a){ga.widget.showError(ga.utils.buildAjaxErrorMessage(t.status,a))}})}catch(a){this.showError(a.message)}},ajaxFiler:function(t){try{var e=ga.utils.getDataAttrs(t,this._ajaxFilerParams);if(_.isUndefined(e["action-url"]))throw new Error("Attribute data-action-url not defined");var a=ga.ui.buildDefaultModal({confirmButton:!1,modalTitle:_.isUndefined(e["modal-title"])?"Upload file":e["modal-title"],modalBody:ga.tpl.ajaxFiler({actionUrl:e["action-url"]})});a.show();var i={};ga.utils.addCsfrtokenData(i);var r=_.isUndefined(e["file-extensions"])?null:e["file-extensions"].split("|");$(a.$modal.find("#filer_input")).filer({changeInput:ga.tpl.ajaxFiler_changeInput(),showThumbs:!0,limit:1,extensions:r,theme:"dragdropbox",templates:{box:ga.tpl.ajaxFiler_box(),item:ga.tpl.ajaxFiler_item(),itemAppend:ga.tpl.ajaxFiler_itemAppend(),progressBar:ga.tpl.ajaxFiler_progresBar(),itemAppendToEnd:!1,removeConfirmation:!0,_selectors:{list:".jFiler-items-list",item:".jFiler-item",progressBar:".bar",remove:".jFiler-item-trash-action"}},uploadFile:{url:e["action-url"],data:i,type:"post",enctype:"multipart/form-data",beforeSend:function(){},success:function(t,e){var a=e.find(".jFiler-jProgressBar").parent();e.find(".jFiler-jProgressBar").fadeOut("slow",function(){$(ga.tpl.ajaxFiler_successMsg()).hide().appendTo(a).fadeIn("slow")}),e.after(t)},error:function(t){var e=t.find(".jFiler-jProgressBar").parent();t.find(".jFiler-jProgressBar").fadeOut("slow",function(){$(ga.tpl.ajaxFiler_errorMsg()).hide().appendTo(e).fadeIn("slow")})}}})}catch(o){this.showError(o.message)}},addProjectGroup:function(t){try{var e=t.next(".add-links");if(0==e.length)throw new Error("No add add links choices set");var a=ga.ui.buildDefaultModal({modalTitle:"Add a project",modalBody:e.html(),closeButtonText:"No"});a.show()}catch(i){this.showError(i.message)}},ajaxUpload:function(t){initUploadFields(t)},showError:function(t){$(".modal,.fade").remove();var e=ga.ui.buildDangerModal({modalTitle:"ERROR",modalBody:t,confirmButton:!1});e.show()},setProjectPanoramic:function(t){try{var e=ga.utils.getDataAttrs(t,this._setProjectPanoramic);if(_.isUndefined(e["ajax-url"]))throw new Error("Attribute data-ajax-url not defined");$.ajax({method:"get",url:e["ajax-url"],error:function(t,e,a){ga.widget.showError(ga.utils.buildAjaxErrorMessage(t.status,a))}})}catch(a){this.showError(a.message)}},linkWidget2Layer:function(t,e){try{var a=ga.utils.getDataAttrs(t,this._linkWidget2Layer);if(_.isUndefined(a["ajax-url"]))throw new Error("Attribute data-ajax-url not defined");var i={};_.isUndefined(e)||e||(i.unlink="unlink"),$.ajax({method:"get",url:a["ajax-url"],data:i,success:function(t){},error:function(t,e,a){ga.widget.showError(ga.utils.buildAjaxErrorMessage(t.status,a))}})}catch(r){this.showError(r.message)}},setLayerCached:function(t,e){try{var a=ga.utils.getDataAttrs(t,this._setLayerCached);if(_.isUndefined(a["ajax-url"]))throw new Error("Attribute data-ajax-url not defined");var i=a["ajax-url"];_.isUndefined(e)||e||(i+="?cached=0"),$.ajax({method:"get",url:i,error:function(t,e,a){ga.widget.showError(ga.utils.buildAjaxErrorMessage(t.status,a))}})}catch(r){this.showError(r.message)}},ajaxDownload:function(t){try{var e=ga.utils.getDataAttrs(t,this._setAjaxDownload);if(_.isUndefined(e["ajax-url"]))throw new Error("Attribute data-ajax-url not defined");$.fileDownload(e["ajax-url"]).fail(function(){ga.widget.showError(ga.utils.buildAjaxErrorMessage(500,"File download Failed!"))})}catch(a){this.showError(a.message)}},showMessageOnLoad:function(t){var e=ga.ui.buildWarningModal({modalTitle:"Warnings!",modalBody:t.html(),closeButtonText:"Close",confirmButton:!1});e.show()},mapSetExtent:function(t){try{var e=ga.utils.getDataAttrs(t,this._mapSetExtent);if(_.isUndefined(e.crs))throw new Error("Attribute data-crs not defined");var a=t.parents(".input-group").find("input"),i=null;a.val()&&(i=ga.utils.transformBBoxToWGS84(e.crs,a.val()));var r=ga.ui.mapModal({bboxLayer:i});r.setConfirmButtonAction(function(t){a.val(ga.utils.transformBBoxFromWGS84(e.crs,r.drawnLayer.getBounds().toBBoxString())),r.hide()}),r.show()}catch(o){this.showError(o.message)}}}),_.extend(g3wadmin.utils,{getDataAttrs:function(t,e){var a={};return _.each(e,function(t){a[t]=this.$item.attr("data-"+t)},{$item:t,params:a}),a},buildAjaxErrorMessage:function(t,e,a){return ga.tpl.ajaxError(_.extendOwn(ga.tpl.tplDefValues.ajaxError,{textStatus:t,errorMessage:e,moreInfo:a}))},addCsfrtokenData:function(t){_.extend(t,{csrfmiddlewaretoken:$.cookie("csrftoken")})},transformBBoxToWGS84:function(t,e){var a=e.split(","),i=proj4(t).inverse([a[0],a[1]]),r=proj4(t).inverse([a[2],a[3]]);return[i[0],i[1],r[0],r[1]].join()},transformBBoxFromWGS84:function(t,e){var a=e.split(","),i=proj4(t).forward([a[0],a[1]]),r=proj4(t).forward([a[2],a[3]]);return[i[0],i[1],r[0],r[1]].join()}}),_.extend(g3wadmin.forms,{checkItemsEmpty:function(t){$formElements=t.find(":input");$.each($formElements,function(t,e){var a=$(e);console.log(a);var i=this.tagName.toLowerCase();switch(console.log(i),i){case"select":console.log(a.val());break;case"radio":case"checkbox":console.log(a.attr("checked"));break;default:console.log(a.val())}})},checkBoxToOpen:function(t){this.checkItemsEmpty(t)},form:function(t){var e=this;this.$form=t;this.on=function(t,a){e.$form.on(t,a)},this.sendData=function(){e.$form.trigger("preSendForm"),$.ajax({method:"post",data:e.getData(),url:e.$form.attr("action"),success:function(t){"error"==t.status?_.has(t,"errors_form")?e.showErrors(t.errors_form):e.showErrors():_.isUndefined(e.successAction)||e.successAction()},complete:function(t,a){e.$form.trigger("postSendForm")},error:function(t,e,a){ga.widget.showError(ga.utils.buildAjaxErrorMessage(t.status,a))}})},this.setOnSuccesAction=function(t){this.successAction=t},this.showErrors=function(t){this.$form.find(".has-error").removeClass("has-error"),this.$form.find("span.help-block").remove(),this.$form.find(".error-form-message").removeClass("hidden"),!_.isUndefined(t)&&_.isObject(t)&&_.mapObject(t,function(t,a){var i=e.$form.find("#div_id_"+a);i.addClass("has-error");var r=i.find(".controls");_.map(t,function(t){r.append(ga.tpl.ajaxFormFieldError({errorId:"error_id_"+a,errorMessage:t}))})})},this.setAction=function(t){this.$form.attr("action",t)},this.getData=function(){var t=this.$form.serializeArray(),e={};for(i in t){var a=t[i];e[a.name]=a.value}return e}}});var $m;$(document).ready(function(){ga.bootstrap()});